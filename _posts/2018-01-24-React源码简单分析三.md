---
layout:     post
title:      React源码简单分析三
date:       2018-01-24
author:     zrd
catalog:    true
tags:
    - React
---

ReactComponent的mountComponent方法
```
mountComponent: function(transaction,hostParent,hostContainerInfo,context){
    this._context = context;
    this._mountOrder = nextMountID++;
    this._hostParent = hostParent;
    this._hostContainerInfo = hostContainerInfo;
    
    //publicProps是nextWrappedElement中的props对象,其中的child属性是ReactDOM.render中传入的ReactElement
    var publicProps = this._currentElement.props;
    var publicContext = this._processContext(context);
    
    //Component为TopLevelWrapper
    var Component = this._currentElement.type;

    var updateQueue = transaction.getUpdateQueue();
    
    var doConstruct = shouldConstruct(Component);
    
    //创建Component即TopLevelWrapper的实例
    var inst = this._constructComponent(
      doConstruct,
      publicProps,
      publicContext,
      updateQueue
    );
    var renderedElement;

    //函数式组件的处理
    if (!doConstruct && (inst == null || inst.render == null)) {
      renderedElement = inst;
      inst = new StatelessComponent(Component);
      this._compositeType = ReactCompositeComponentTypes.StatelessFunctional;
    } else {
      if (isPureComponent(Component)) {
        this._compositeType = ReactCompositeComponentTypes.PureClass;
      } else {
        this._compositeType = ReactCompositeComponentTypes.ImpureClass;
      }
    }

    var propsMutated = inst.props !== publicProps;
    var componentName = Component.displayName || Component.name || 'Component';
    
    
    inst.props = publicProps;
    inst.context = publicContext;
    inst.refs = emptyObject;
    inst.updater = updateQueue;
    
    //注意这里的this是ReactComponent对象,inst是TopLevelWrapper
    this._instance = inst;

    //存储实例对象的引用到map中，方便以后查找
    ReactInstanceMap.set(inst, this);

    var initialState = inst.state;
    if (initialState === undefined) {
      inst.state = initialState = null;
    }

    this._pendingStateQueue = null;
    this._pendingReplaceState = false;
    this._pendingForceUpdate = false;

    if (inst.componentWillMount) {
      inst.componentWillMount();
      if (this._pendingStateQueue) {
        inst.state = this._processPendingState(inst.props, inst.context);
      }
    }
    
    //挂载时出错,进行一些错误处理,然后performInitialMount
    var markup;
    if (inst.unstable_handleError) {
      markup = this.performInitialMountWithErrorHandling(
        renderedElement,
        hostParent,
        hostContainerInfo,
        transaction,
        context
      );
    } else {
      markup = this.performInitialMount(
        renderedElement,
        hostParent,
        hostContainerInfo,
        transaction,
        context
      );
    }

    if (inst.componentDidMount) {
        transaction.getReactMountReady().enqueue(inst.componentDidMount, inst);
    }

    const callbacks = this._pendingCallbacks;
    if (callbacks) {
      this._pendingCallbacks = null;
      for (let i = 0; i < callbacks.length; i++) {
        transaction.getReactMountReady().enqueue(
          callbacks[i],
          inst
        );
      }
    }

    return markup;
}

var TopLevelWrapper = function() {
  this.rootID = topLevelRootCounter++;
};
TopLevelWrapper.prototype.isReactComponent = {};
TopLevelWrapper.prototype.render = function() {
  return this.props.child;
};
TopLevelWrapper.isReactTopLevelWrapper = true;
  
```

