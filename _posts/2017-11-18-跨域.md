---
layout:     post
title:      跨域
date:       2017-11-18
author:     zrd
catalog:    true
tags:
    - JS
---

## 什么是跨域?

只要协议、域名、端口有任何一个不同,都被当做不同的域,之间的请求就是跨域操作。

## 同源策略

浏览器的同源策略会导致跨域,同源策略又分为以下两种:
1. DOM同源策略: 禁止对不同源页面DOM进行操作
2. XMLHttpRequest同源策略: 禁止使用XHR对象向不同源的服务器地址发起HTTP请求

## 跨域的解决方式

### 跨域资源共享CORS(Cross-origin resource sharing)

对于客户端而言,正常使用xhr对象发送ajax请求,浏览器会自动在头信息中添加`Origin`字段,用来说明本次请求来自哪个源。

对于服务器而言,如果`Origin`指定的源不在许可范围内,服务器会返回一个正常的HTTP响应,响应头信息中没有`Access-Control-Allow-Origin`字段,会抛出错误,
被xhr的onerror回调函数捕获。若在许可范围内,则响应中会多出几个头信息字段:
1. Access-Control-Allow-Origin(必须): 值为`Origin`字段的值或*,表示接受任意域名的请求。
2. Access-Control-Allow-Credentials(可选): 表示是否允许发送cookie。默认情况下,cookie不包含在CORS请求中。
3. Access-Control-Expose-Headers(可选): CORS请求时,xhr对象的getResponseHeader()方法只能拿到6个基本字段: Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。
   如果想拿到其他字段,就必须在Access-Control-Expose-Headers里面指定。
   
#### widthCredentials属性

CORS请求默认不发送cookie和HTTP认证信息,若要把cookie发到服务器,服务器要指定`Access-Control-Allow-Credentials: true`,开发者必须在ajax请求中设置`xhr.withCredentials = true`

### jsonp实现跨域

jsonp由两部分组成: 回调函数和数据。

回调函数是当响应到来时应该在页面中调用的函数。数据是传入回调函数的json数据。

注: jsonp只支持get请求,但兼容性更好。

### 服务器代理

浏览器有跨域限制,服务器没有,可以由服务器请求所要域的资源再返回给客户端。

#### document.domain来跨子域

对于主域名相同而子域名不同的情况,可以使用此方法跨域。

比如: a页面地址为a.yourhost.com,b页面地址为b.yourhost.com,分别给两页面设置document.domain = yourhost.com来实现跨域。

#### window.name进行跨域

window对象有个name属性,该属性有个特征: 即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的,
每个页面对window.name都有读写的权限,window.name是持久存在一个窗口载入过的所有页面中的。

### 使用postMessage实现页面之间通信

window.postMessage(message,targetOrigin) 方法是html5新引进的特性,可以使用它来向其它的window对象发送消息,无论这个window对象是属于同源或不同源,
目前IE8+、FireFox、Chrome、Opera等浏览器都已经支持window.postMessage方法。














