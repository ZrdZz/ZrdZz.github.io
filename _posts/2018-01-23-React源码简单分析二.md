---
layout:     post
title:      React源码简单分析二
date:       2018-01-23
author:     zrd
catalog:    true
tags:
    - React
---

经过babel转码后,`ReactDOM.render()`将组件插入DOM中

`ReactDOM.render`指向`ReactMount.render()`,其中又调用`ReactMount._renderSubtreeIntoContainer(null, nextElement, container, callback)`

```
/*
 * @param {parentComponent},父组件,第一次渲染为null
 * @param {nextElement}, 是一个ReactElement对象
 * @param {container}, 要插入到的容器
 * @param {callback}, 第一次渲染为null
 * @param {component}, 返回一个ReactComponent对象
 */
_renderSubtreeIntoContainer: function(parentComponent, nextElement, container, callback) {
    callback = callback === undefined ? null : callback;

    //包装传入的ReactElement,将其挂载到nextWrappedElement.props.child下面
    var nextWrappedElement = React.createElement(
      TopLevelWrapper,
      { child: nextElement }
    );

    var nextContext = getContextForSubtree(parentComponent);
    //获取插入容器的前一次的ReactComponent,为了做DOM diff,第一次调用为null
    var prevComponent = getTopLevelWrapperInContainer(container);

    if (prevComponent) {
      var prevWrappedElement = prevComponent._currentElement;
      var prevElement = prevWrappedElement.props.child;
      if (shouldUpdateReactComponent(prevElement, nextElement)) {
        var publicInst = prevComponent._renderedComponent.getPublicInstance();
        var updatedCallback = callback && function() {
          validateCallback(callback);
          callback.call(publicInst);
        };
        ReactMount._updateRootComponent(
          prevComponent,
          nextWrappedElement,
          nextContext,
          container,
          updatedCallback
        );
        return publicInst;
      } else {
        ReactMount.unmountComponentAtNode(container);
      }
    }

    var reactRootElement = getReactRootElementInContainer(container);
    var containerHasReactMarkup =
      reactRootElement && !!internalGetID(reactRootElement);
    var containerHasNonRootReactChild = hasNonRootReactChild(container);

    var shouldReuseMarkup =
      containerHasReactMarkup &&
      !prevComponent &&
      !containerHasNonRootReactChild;
    var component = ReactMount._renderNewRootComponent(
      nextWrappedElement,
      container,
      shouldReuseMarkup,
      nextContext,
      callback
    )._renderedComponent.getPublicInstance();
    return component;
  },
```
